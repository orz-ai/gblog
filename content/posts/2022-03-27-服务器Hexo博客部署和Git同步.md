---
title: 服务器Hexo博客部署和Git同步
date: 2022-03-27 23:54:00
summary: 搬瓦工服务器搭建Hexo博客并使用git同步
tags: ["Linux"]

---

# 安装hexo

```sh
npm install -g hexo-cli
npm install hexo-deployer-git --save
```



# 搭建git服务器

## 安装git环境

```bash
# 查看是否安装
git --version

# 若未安装，需先安装git
sudo apt-get install git
```



## 创建git用户

```bash
adduser git 
passwd git // 设置密码
su git // 切换用户
```



## 创建git仓库

```bash
cd /home/git/
# 创建文件来放置hexo静态工程
mkdir -p projects/blog
# 创建文件放置git仓库
mkdir repos && cd repos
# 创建一个裸露的仓库
git init --bare blog.git
```

## 创建钩子函数

```bash
cd blog.git/hooks

# 创建hook钩子函数 git提交时自动部署博客内容
vi post-receive 

hook钩子函数内容:
#!/bin/sh
git --work-tree=/home/git/projects/blog --git-dir=/home/git/repos/blog.git checkout -f

chmod +x post-receive
# 退出git用户
exit
# 添加权限
chown -R git:git /home/git/repos/blog.git
```



## 测试git仓库

```BASH
# 如果ssh是22端口
git clone git@server_ip:/home/git/repos/blog.git

# 如果ssh非22端口
git clone ssh://git@server_ip:port/home/git/repos/blog.git
```



## 配置SSH免密登录

### 客户端（Windows这边）

> 方法一

`git bash`中生成git客户的的公私密钥对

```bash
ssh-keygen

# 接下来可以一直回车
```

会在`C:\Users\用户名`下生成一个`.ssh`中生成密钥对，复制公钥`id_rsa.pub`中的内容，准备粘贴到下面创建的`authorized_keys`文件中



> 方法二

1. 生成密钥对

   ```bash
   ssh-keygen -t rsa -C "youremail@example.com"
   ```

2. 将公钥传送给服务器

   ```bash
   # ssh 使用的是22端口
   ssh-copy-id -i ~/.ssh/id_rsa.pub username@server_ip
   
   # ssh 使用的非22端口
   ssh-copy-id -p 'port' -i ~/.ssh/id_rsa.pub username@server_ip
   ```

   



### 服务器（Linux这边）

1. 编辑`/etc/ssh/sshd_config`文件开启免密登录

   ```bash
   RSAAuthentication yes
   PubkeyAuthentication yes
   
   # 配置修改完重启ssh服务
   service sshd restart
   ```

2. 创建指定用户目录下`authorized_keys`

   ```bash
   cd /home/git/.ssh
   # 存放客户端的ssh公钥 id_rsa.pub
   touch authorized_keys
   # 粘贴客户端公钥
   
   # 配置权限
   chmod 600 authorized_keys
   chmod 700 ~/.ssh
   
   # 权限给的太大可能会失败? SSH不允许.ssh目录权限过大？
   ```

3. 限制git用户登录权限, 只能clone, push;

   ```bash
   # 查看`git-shell`是否在登录方式里面，有则跳过
   cat /etc/shells
   # 查看是否安装 
   which git-shell
   vi /etc/shells
   # 添加(which git-shell)显示出来的路劲，通常在 /usr/bin/git-shell
   ```

   修改`/etc/passwd`中的权限

   ```bash
   # 将原来的
   git:x:1000:1000:,,,:/home/git:/bin/bash
   # 修改为:
   git:x:1000:1000:,,,:/home/git:/usr/bin/git-shell
   ```

   

# 配置nginx

nginx.conf配置文件内容：

```nginx
location / {
    root   /home/git/projects/blog;
    index  index.html index.htm;
}

# 同时将user改为root
```



# 选择主题

[官方主题](https://hexo.io/themes/)

选择一个下载到本地

选择`NexT`



# 启动

```bash
npm run deploy
```





# 遇到的问题

1. `ERROR Deployer not found: git`报错

   需要安装`hexo-deployer-git` 模块： `npm install hexo-deployer-git --save`

   确认配置文件`_config.yml`中是否添加git仓库信息：

   ```bas
   deploy:
     type: git
     repo: ssh://git@server_ip:port/home/git/repos/blog.git
     branch: master
   ```

   

2. `yum`安装`nodejs`后没有安装`npm`

   ```bash
   # 指定仓库地址
   curl --silent --location https://rpm.nodesource.com/setup_10.x | bash -
   # 再安装
   yum install -y nodejs
   
   # 切换至国内的源（如果是过内服务器的话）
   npm install -g cnpm --registry=https://registry.npm.taobao.org 
   ```

   
