<!DOCTYPE html>
<html lang="{{ .Site.LanguageCode }}">

<head>
    {{ partial "head.html" . }}
</head>

<body>
    {{ partial "header.html" . }}
    <main class="main">
        <div class="container">
            <article class="post">
                <header class="post-header">
                    <h1 class="post-title">{{ .Title }}</h1>
                    <div class="post-meta">
                        <time datetime="{{ .Date.Format " 2006-01-02T15:04:05Z07:00" }}">
                            {{ .Date.Format .Site.Params.dateFormat }}
                        </time>

                        {{ with .Params.categories }}
                        <span class="post-category">
                            <i class="fas fa-folder"></i>
                            {{ range first 1 . }}
                            <a href="{{ " categories/" | relLangURL }}{{ . | urlize }}/">{{ . }}</a>
                            {{ end }}
                        </span>
                        {{ end }}

                        {{ if isset .Params "author" }}
                        <span class="post-author">
                            <i class="fas fa-user"></i> {{ .Params.author }}
                        </span>
                        {{ end }}

                        <span class="post-reading-time">
                            <i class="fas fa-clock"></i> {{ .ReadingTime }} 分钟阅读
                        </span>
                    </div>

                    {{ with .Params.tags }}
                    <div class="post-tags">
                        {{ range . }}
                        <a href='{{ "tags/" | relLangURL }}{{ . | urlize }}/' class="tag">{{ . }}</a>
                        {{ end }}
                    </div>
                    {{ end }}
                </header>

                <div class="post-content">
                    {{ .Content }}

                    <div class="content-end">
                        <div class="end-line"></div>
                        <div class="end-text">— END —</div>
                    </div>
                </div>

                <div class="post-extra">
                    {{ if .Params.tags }}
                    <div class="extra-section">
                        <div class="extra-title">相关标签</div>
                        <div class="tags-list">
                            {{ range .Params.tags }}
                            <a href='{{ "tags/" | relLangURL }}{{ . | urlize }}/' class="tag-link">{{ . }}</a>
                            {{ end }}
                        </div>
                    </div>
                    {{ end }}

                    <div class="extra-section">
                        <div class="extra-title">推荐阅读</div>
                        <div class="recommend-grid">
                            {{ $related := .Site.RegularPages.Related . | first 4 }}
                            {{ if $related }}
                            {{ range $related }}
                            <a href="{{ .Permalink }}" class="recommend-card">
                                <div class="recommend-image">
                                    {{ if .Params.featuredImage }}
                                    <img src="{{ .Params.featuredImage }}" alt="{{ .Title }}">
                                    {{ else }}
                                    <div class="recommend-placeholder"></div>
                                    {{ end }}
                                </div>
                                <div class="recommend-info">
                                    <div class="recommend-title">{{ .Title }}</div>
                                    <div class="recommend-date">{{ .Date.Format "2006-01-02" }}</div>
                                </div>
                            </a>
                            {{ end }}
                            {{ else }}
                            {{ range first 4 (where .Site.RegularPages "Section" .Section) }}
                            {{ if ne .Permalink $.Permalink }}
                            <a href="{{ .Permalink }}" class="recommend-card">
                                <div class="recommend-image">
                                    {{ if .Params.featuredImage }}
                                    <img src="{{ .Params.featuredImage }}" alt="{{ .Title }}">
                                    {{ else }}
                                    <div class="recommend-placeholder"></div>
                                    {{ end }}
                                </div>
                                <div class="recommend-info">
                                    <div class="recommend-title">{{ .Title }}</div>
                                    <div class="recommend-date">{{ .Date.Format "2006-01-02" }}</div>
                                </div>
                            </a>
                            {{ end }}
                            {{ end }}
                            {{ end }}
                        </div>
                    </div>
                </div>

                <div class="post-footer">
                    <div class="post-nav">
                        {{ with .PrevInSection }}
                        <a href="{{ .Permalink }}" class="post-nav-prev">
                            <i class="fas fa-arrow-left"></i>
                            <span>{{ .Title }}</span>
                        </a>
                        {{ end }}

                        {{ with .NextInSection }}
                        <a href="{{ .Permalink }}" class="post-nav-next">
                            <span>{{ .Title }}</span>
                            <i class="fas fa-arrow-right"></i>
                        </a>
                        {{ end }}
                    </div>
                </div>
            </article>

            <!-- 文章目录 -->
            <div class="toc-container" id="tocContainer">
                <div class="toc-header">
                    <span><i class="fas fa-list"></i> 目录</span>
                    <button class="toc-hide-btn" id="tocHideBtn" title="收起目录">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
                <nav class="toc-nav" id="tocNav">
                    <!-- 目录内容将通过JavaScript生成 -->
                </nav>
            </div>
        </div>
    </main>

    {{ partial "footer.html" . }}

    <a href="#" class="back-to-top" id="backToTop" aria-label="返回顶部">
        <i class="fas fa-arrow-up"></i>
    </a>

    <!-- 显示目录按钮 -->
    <button class="toc-show-btn" id="tocShowBtn" title="显示目录" style="display: none;">
        <i class="fas fa-list"></i>
    </button>

    <script>
        // 返回顶部按钮
        document.addEventListener('DOMContentLoaded', function () {
            var backToTop = document.getElementById('backToTop');

            window.addEventListener('scroll', function () {
                if (window.pageYOffset > 300) {
                    backToTop.classList.add('show');
                } else {
                    backToTop.classList.remove('show');
                }
            });

            backToTop.addEventListener('click', function (e) {
                e.preventDefault();
                window.scrollTo({ top: 0, behavior: 'smooth' });
            });

            // 增强代码块功能
            document.querySelectorAll('.highlight').forEach(function (highlight) {
                // 添加复制按钮
                if (!highlight.querySelector('.copy-button')) {
                    let copyButton = document.createElement('button');
                    copyButton.className = 'copy-button';
                    copyButton.textContent = '复制';

                    highlight.appendChild(copyButton);

                    copyButton.addEventListener('click', function () {
                        let codeElement = highlight.querySelector('code');
                        let textToCopy = codeElement.textContent;

                        navigator.clipboard.writeText(textToCopy).then(function () {
                            copyButton.textContent = '已复制!';
                            setTimeout(function () {
                                copyButton.textContent = '复制';
                            }, 2000);
                        }).catch(function (err) {
                            console.error('无法复制文本: ', err);
                        });
                    });
                }

                // 提取语言信息并添加为内部标签
                let codeClass = highlight.querySelector('code').className;
                let langMatch = codeClass.match(/language-(\w+)/);

                if (langMatch && langMatch[1]) {
                    let lang = langMatch[1];
                    // 删除可能已存在的语言标识
                    let existingIndicator = highlight.querySelector('.language-indicator');
                    if (existingIndicator) {
                        existingIndicator.remove();
                    }

                    // 创建并添加新的语言标识在代码块内部的左上角
                    let langIndicator = document.createElement('div');
                    langIndicator.className = 'language-indicator';
                    langIndicator.textContent = lang;
                    highlight.insertBefore(langIndicator, highlight.firstChild);
                }
            });

            // 目录功能
            const tocContainer = document.getElementById('tocContainer');
            const tocNav = document.getElementById('tocNav');
            const postContent = document.querySelector('.post-content');

            if (!postContent) return;

            // 自动给标题添加序号
            function addHeadingNumbers() {
                const headings = postContent.querySelectorAll('h1, h2, h3, h4, h5, h6');
                let counters = [0, 0, 0, 0, 0, 0]; // 用于跟踪各级标题的计数

                headings.forEach(heading => {
                    const level = parseInt(heading.tagName.charAt(1)) - 1; // h1=0, h2=1, ...

                    // 更新当前级别的计数器
                    counters[level]++;

                    // 重置更深层级的计数器
                    for (let i = level + 1; i < counters.length; i++) {
                        counters[i] = 0;
                    }

                    // 构建序号字符串
                    let numberStr = '';
                    for (let i = 0; i <= level; i++) {
                        if (counters[i] > 0) {
                            numberStr += (numberStr ? '.' : '') + counters[i];
                        }
                    }
                    numberStr += '. ';

                    // 添加序号到标题前面
                    const numberSpan = document.createElement('span');
                    numberSpan.className = 'heading-number';
                    numberSpan.textContent = numberStr;
                    heading.insertBefore(numberSpan, heading.firstChild);
                });
            }

            // 生成目录
            function generateTOC() {
                const headings = postContent.querySelectorAll('h1, h2, h3, h4, h5, h6');
                if (headings.length === 0) {
                    tocContainer.style.display = 'none';
                    return;
                }

                tocNav.innerHTML = '';
                let levelStack = [];

                headings.forEach((heading, index) => {
                    const level = parseInt(heading.tagName.charAt(1));
                    const id = heading.id || `heading-${index}`;
                    heading.id = id;

                    // 处理层级
                    while (levelStack.length > 0 && levelStack[levelStack.length - 1].level >= level) {
                        levelStack.pop();
                    }

                    const listItem = document.createElement('li');
                    listItem.className = `toc-item toc-level-${level}`;

                    const link = document.createElement('a');
                    link.href = `#${id}`;
                    link.className = 'toc-link';
                    link.setAttribute('data-target', id);
                    link.innerHTML = `<span class="toc-text">${heading.textContent}</span>`;

                    listItem.appendChild(link);

                    // 添加到合适的父级
                    if (levelStack.length === 0) {
                        tocNav.appendChild(listItem);
                    } else {
                        const parent = levelStack[levelStack.length - 1];
                        let subList = parent.element.querySelector('ul');
                        if (!subList) {
                            subList = document.createElement('ul');
                            subList.className = 'toc-list';
                            parent.element.appendChild(subList);

                            // 添加点击展开/折叠功能到父级链接
                            const parentLink = parent.element.querySelector('.toc-link');
                            if (parentLink && !parentLink.classList.contains('toc-expandable')) {
                                parentLink.classList.add('toc-expandable');
                                parentLink.addEventListener('click', function (e) {
                                    if (e.target.closest('.toc-link') === this) {
                                        e.preventDefault();
                                        subList.classList.toggle('toc-collapsed');
                                        this.classList.toggle('toc-expanded');
                                    }
                                });
                            }
                        }
                        subList.appendChild(listItem);
                    }

                    levelStack.push({ level: level, element: listItem });
                });
            }

            // 滚动监听和高亮
            function updateActiveHeading() {
                const headings = postContent.querySelectorAll('h1, h2, h3, h4, h5, h6');
                const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
                const windowHeight = window.innerHeight;
                const documentHeight = document.documentElement.scrollHeight;

                let activeHeading = null;
                let closestHeading = null;
                let closestDistance = Infinity;

                // 查找距离视口中心最近的标题
                headings.forEach(heading => {
                    const rect = heading.getBoundingClientRect();
                    const headingCenter = rect.top + rect.height / 2;
                    const viewportCenter = windowHeight / 2;
                    const distance = Math.abs(headingCenter - viewportCenter);

                    // 只考虑已经滚动过的标题（在视口中心以上的）
                    if (headingCenter <= viewportCenter && distance < closestDistance) {
                        closestDistance = distance;
                        closestHeading = heading;
                    }
                });

                activeHeading = closestHeading;

                // 如果没有找到，检查是否接近底部
                if (!activeHeading) {
                    const isNearBottom = (scrollTop + windowHeight) >= documentHeight - 100;
                    if (isNearBottom && headings.length > 0) {
                        activeHeading = headings[headings.length - 1];
                    }
                }

                // 移除所有活动状态
                document.querySelectorAll('.toc-link').forEach(link => {
                    link.classList.remove('active');
                    link.parentElement.classList.remove('active');
                });

                // 添加当前活动状态
                if (activeHeading) {
                    const activeLink = document.querySelector(`[data-target="${activeHeading.id}"]`);
                    if (activeLink) {
                        activeLink.classList.add('active');
                        activeLink.parentElement.classList.add('active');

                        // 展开父级目录
                        let parent = activeLink.parentElement.parentElement;
                        while (parent && parent.classList.contains('toc-list')) {
                            parent.style.display = 'block';
                            parent = parent.parentElement.parentElement;
                        }
                    }
                }
            }

            // 平滑滚动到目标位置
            document.addEventListener('click', function (e) {
                if (e.target.closest('.toc-link')) {
                    e.preventDefault();
                    const targetId = e.target.closest('.toc-link').getAttribute('data-target');
                    const targetElement = document.getElementById(targetId);

                    if (targetElement) {
                        const offsetTop = targetElement.getBoundingClientRect().top + window.pageYOffset - 100;
                        window.scrollTo({
                            top: offsetTop,
                            behavior: 'smooth'
                        });
                    }
                }
            });

            // 初始化
            addHeadingNumbers(); // 先添加序号
            generateTOC(); // 再生成目录
            updateActiveHeading();

            // 为目录隐藏/展开按钮添加点击事件
            const tocHideBtn = document.getElementById('tocHideBtn');
            const tocShowBtn = document.getElementById('tocShowBtn');

            if (tocHideBtn) {
                tocHideBtn.addEventListener('click', function () {
                    // 收起目录
                    tocContainer.classList.add('hidden');
                    if (tocShowBtn) {
                        tocShowBtn.style.display = 'block';
                    }
                });
            }

            if (tocShowBtn) {
                tocShowBtn.addEventListener('click', function () {
                    // 展开目录
                    tocContainer.classList.remove('hidden');
                    tocShowBtn.style.display = 'none';
                });
            }

            // 监听滚动事件
            let ticking = false;
            window.addEventListener('scroll', function () {
                if (!ticking) {
                    requestAnimationFrame(function () {
                        updateActiveHeading();
                        ticking = false;
                    });
                    ticking = true;
                }
            });
        });
    </script>
</body>

</html>